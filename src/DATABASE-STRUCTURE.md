# ๐ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช | Database Structure

> ูุธุงู ุฅุฏุงุฑุฉ ุงูุญุถูุฑ ุงูุฐูู - ุฌุงูุนุฉ ุงูููู ุฎุงูุฏ

---

## ๐๏ธ ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ | Core Tables

### 1. `profiles` - ุงููููุงุช ุงูุดุฎุตูุฉ

ููุชุฏ ูู `auth.users` ููุญุชูู ุนูู ูุนูููุงุช ุงููุณุชุฎุฏู.

**ุงูุฃุนูุฏุฉ:**
- `id` (UUID) - Primary Key, references auth.users
- `full_name` (TEXT) - ุงูุงุณู ุงููุงูู
- `email` (TEXT) - ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (unique)
- `role` (TEXT) - ุงูุฏูุฑ: `supervisor`, `teacher`, `student`
- `student_number` (TEXT) - ุงูุฑูู ุงูุฌุงูุนู (ููุทูุงุจ ููุท)
- `created_at` (TIMESTAMPTZ) - ุชุงุฑูุฎ ุงูุฅูุดุงุก

**ุงูููุงุญุธุงุช:**
- โ ูุชู ุฅูุดุงุก ุงูุณุฌู ุชููุงุฆูุงู ุนูุฏ ุงูุชุณุฌูู (trigger)
- โ ุงูุทูุงุจ ููุท ูุญุชุงุฌูู `student_number`
- โ RLS: ูู ูุณุชุฎุฏู ูุฑู ูููู ููุท

---

### 2. `courses` - ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ

**ุงูุฃุนูุฏุฉ:**
- `id` (UUID) - Primary Key
- `code` (TEXT) - ุฑูุฒ ุงููุงุฏุฉ (unique) - ูุซุงู: `CIS342`
- `name` (TEXT) - ุงุณู ุงููุงุฏุฉ - ูุซุงู: `ูุธู ููุงุนุฏ ุงูุจูุงูุงุช`
- `instructor_id` (UUID) - ูุนุฑู ุงููุนูู (references profiles)
- `created_at` (TIMESTAMPTZ) - ุชุงุฑูุฎ ุงูุฅูุดุงุก

**ุงูุนูุงูุงุช:**
- `instructor_id` โ `profiles.id` (ุงููุนูู)

**ุงูููุงุญุธุงุช:**
- โ RLS: ุงูุฌููุน ูููููู ุนุฑุถ ุงูููุงุฏ
- โ ููุท ุงููุนูู ูุงููุดุฑู ูููููู ุงูุชุนุฏูู

---

### 3. `sections` - ุงูุดุนุจ/ุงูุฃูุณุงู

**ุงูุฃุนูุฏุฉ:**
- `id` (UUID) - Primary Key
- `course_id` (UUID) - ูุนุฑู ุงููุงุฏุฉ (references courses)
- `name` (TEXT) - ุงุณู ุงูุดุนุจุฉ - ูุซุงู: `ุงูุดุนุจุฉ 1`

**ุงูุนูุงูุงุช:**
- `course_id` โ `courses.id`

**ุงููููุฏ:**
- UNIQUE(course_id, name) - ูุง ูููู ุชูุฑุงุฑ ููุณ ุงูุดุนุจุฉ ูููุงุฏุฉ

**ุงูููุงุญุธุงุช:**
- โ ูู ูุงุฏุฉ ูููู ุฃู ูููู ููุง ุนุฏุฉ ุดุนุจ
- โ RLS: ุงูุฌููุน ูููููู ุนุฑุถ ุงูุดุนุจ

---

### 4. `schedules` - ุงูุฌุฏุงูู ุงูุฏุฑุงุณูุฉ

**ุงูุฃุนูุฏุฉ:**
- `id` (UUID) - Primary Key
- `section_id` (UUID) - ูุนุฑู ุงูุดุนุจุฉ (references sections)
- `day_of_week` (INTEGER) - ููู ุงูุฃุณุจูุน (0=ุงูุฃุญุฏ, 6=ุงูุณุจุช)
- `start_time` (TIME) - ููุช ุงูุจุฏุก - ูุซุงู: `08:00`
- `end_time` (TIME) - ููุช ุงูููุงูุฉ - ูุซุงู: `09:30`
- `location` (TEXT) - ุงูููุงู - ูุซุงู: `ูุนูู 203`

**ุงูุนูุงูุงุช:**
- `section_id` โ `sections.id`

**ุงูููุงุญุธุงุช:**
- โ `day_of_week`: 0=ุงูุฃุญุฏุ 1=ุงูุงุซูููุ 2=ุงูุซูุงุซุงุกุ ... 6=ุงูุณุจุช
- โ RLS: ุงูุฌููุน ูููููู ุนุฑุถ ุงูุฌุฏุงูู

---

### 5. `sessions` - ุงูุฌูุณุงุช (ุงูููุงุกุงุช ุงููุนููุฉ)

**ุงูุฃุนูุฏุฉ:**
- `id` (UUID) - Primary Key
- `section_id` (UUID) - ูุนุฑู ุงูุดุนุจุฉ (references sections)
- `starts_at` (TIMESTAMPTZ) - ููุช ุงูุจุฏุก ุงููุนูู
- `ends_at` (TIMESTAMPTZ) - ููุช ุงูููุงูุฉ ุงููุนูู
- `code` (TEXT) - ููุฏ ุงูุญุถูุฑ (unique) - ูุซุงู: `CIS342-20251110-143022`
- `qr_svg` (TEXT) - ุฑูุฒ QR (ุงุฎุชูุงุฑู)
- `require_webauthn` (BOOLEAN) - ูู ุชุชุทูุจ ุจุตูุฉุ (default: true)

**ุงูุนูุงูุงุช:**
- `section_id` โ `sections.id`

**ุงูููุงุญุธุงุช:**
- โ ูุฐู ูู ุงูุฌูุณุงุช ุงููุนููุฉ (ุงููููุ ุงูุฃุณุจูุน ุงููุงุถูุ ุฅูุฎ)
- โ ูุชู ุฅูุดุงุคูุง ูู ูุจู ุงููุนูู ุนูุฏ ุจุฏุก ุงูุญุตุฉ
- โ RLS: ุงูุฌููุน ูููููู ุนุฑุถ ุงูุฌูุณุงุช

---

### 6. `attendance` - ุณุฌูุงุช ุงูุญุถูุฑ

**ุงูุฃุนูุฏุฉ:**
- `id` (UUID) - Primary Key
- `session_id` (UUID) - ูุนุฑู ุงูุฌูุณุฉ (references sessions)
- `student_id` (UUID) - ูุนุฑู ุงูุทุงูุจ (references profiles)
- `status` (TEXT) - ุงูุญุงูุฉ: `present`, `absent`, `late`, `excused`
- `marked_at` (TIMESTAMPTZ) - ููุช ุงูุชุณุฌูู (default: NOW)
- `method` (TEXT) - ุทุฑููุฉ ุงูุชุณุฌูู: `code`, `qr`, `webauthn`

**ุงูุนูุงูุงุช:**
- `session_id` โ `sessions.id`
- `student_id` โ `profiles.id`

**ุงููููุฏ:**
- UNIQUE(session_id, student_id) - ูุง ูููู ููุทุงูุจ ุงูุชุณุฌูู ูุฑุชูู ูู ููุณ ุงูุฌูุณุฉ

**ุงูููุงุญุธุงุช:**
- โ RLS: ุงูุทูุงุจ ูุฑูู ุญุถูุฑูู ููุท
- โ ุงููุนูููู ูุฑูู ุญุถูุฑ ุทูุงุจูู
- โ ุงููุดุฑููู ูุฑูู ูู ุงูุณุฌูุงุช

---

### 7. `webauthn_credentials` - ุจูุงูุงุช ุงุนุชูุงุฏ ุงูุจุตูุฉ

**ุงูุฃุนูุฏุฉ:**
- `id` (UUID) - Primary Key
- `user_id` (UUID) - ูุนุฑู ุงููุณุชุฎุฏู (references profiles)
- `credential_id` (TEXT) - ูุนุฑู ุงูุงุนุชูุงุฏ (unique)
- `public_key` (TEXT) - ุงูููุชุงุญ ุงูุนุงู
- `counter` (BIGINT) - ุนุฏุงุฏ ุงูุงุณุชุฎุฏุงู (default: 0)
- `created_at` (TIMESTAMPTZ) - ุชุงุฑูุฎ ุงูุฅูุดุงุก

**ุงูุนูุงูุงุช:**
- `user_id` โ `profiles.id`

**ุงูููุงุญุธุงุช:**
- โ ุชุณุชุฎุฏู ูุชุณุฌูู ุงูุญุถูุฑ ุนุจุฑ ุงูุจุตูุฉ
- โ RLS: ูู ูุณุชุฎุฏู ูุฑู ุจูุงูุงุช ุงุนุชูุงุฏู ููุท

---

### 8. `allowed_students` - ูุงุฆูุฉ ุงูุทูุงุจ ุงููุณููุญ ููู

**ุงูุฃุนูุฏุฉ:**
- `student_number` (TEXT) - Primary Key - ุงูุฑูู ุงูุฌุงูุนู
- `full_name` (TEXT) - ุงูุงุณู ุงููุงูู
- `email_domain` (TEXT) - ุงููุทุงู (default: 'kku.edu.sa')
- `active` (BOOLEAN) - ูุดุทุ (default: true)

**ุงูููุงุญุธุงุช:**
- โ ูุงุฆูุฉ ุจูุถุงุก ููุทูุงุจ ุงููุณููุญ ููู ุจุงูุชุณุฌูู
- โ RLS: ุงููุดุฑููู ููุท ูููููู ุงูุฅุฏุงุฑุฉ

---

## ๐ ุงูุนูุงูุงุช | Relationships

```
profiles (ุงููุณุชุฎุฏููู)
  โโ> courses.instructor_id (ุงูููุงุฏ ุงูุชู ูุฏุฑุณูุง)
  โโ> attendance.student_id (ุณุฌูุงุช ุงูุญุถูุฑ)
  โโ> webauthn_credentials.user_id (ุจูุงูุงุช ุงูุจุตูุฉ)

courses (ุงูููุงุฏ)
  โโ> sections (ุงูุดุนุจ)
      โโ> schedules (ุงูุฌุฏุงูู ุงูุฃุณุจูุนูุฉ)
      โโ> sessions (ุงูุฌูุณุงุช ุงููุนููุฉ)
          โโ> attendance (ุณุฌูุงุช ุงูุญุถูุฑ)
```

---

## ๐ ูุซุงู ุนููู | Practical Example

### ุงูุณููุงุฑูู:
ุฏ. ูุญูุฏ ูุฏุฑูุณ ูุงุฏุฉ **ูุธู ููุงุนุฏ ุงูุจูุงูุงุช (CIS342)** ูุดุนุจุฉ ูุงุญุฏุฉุ ุชูุฏุฑูุณ ุงูุฃุญุฏ ูุงูุซูุงุซุงุก ูู 8:00 ุฅูู 9:30 ูู ูุนูู 203.

### ุงูุจูุงูุงุช ูู ุงูุฌุฏุงูู:

**1. profiles:**
```sql
id: 123e4567-...
full_name: ุฏ. ูุญูุฏ ุฃุญูุฏ
email: teacher@kku.edu.sa
role: teacher
```

**2. courses:**
```sql
id: 789abcde-...
code: CIS342
name: ูุธู ููุงุนุฏ ุงูุจูุงูุงุช
instructor_id: 123e4567-... (ุฏ. ูุญูุฏ)
```

**3. sections:**
```sql
id: 456fghij-...
course_id: 789abcde-... (CIS342)
name: ุงูุดุนุจุฉ 1
```

**4. schedules (ุฌุฏูููู: ุงูุฃุญุฏ ูุงูุซูุงุซุงุก):**
```sql
# ุงูุฃุญุฏ
section_id: 456fghij-...
day_of_week: 0
start_time: 08:00
end_time: 09:30
location: ูุนูู 203

# ุงูุซูุงุซุงุก
section_id: 456fghij-...
day_of_week: 2
start_time: 08:00
end_time: 09:30
location: ูุนูู 203
```

**5. sessions (ุฌูุณุฉ ุงูููู - ุงูุฃุญุฏ):**
```sql
id: 321klmno-...
section_id: 456fghij-...
starts_at: 2025-11-10 08:00:00+03
ends_at: 2025-11-10 09:30:00+03
code: CIS342-20251110-080000
require_webauthn: false
```

**6. attendance (ุทุงูุจ ุณุฌูู ุญุถูุฑู):**
```sql
session_id: 321klmno-... (ุฌูุณุฉ ุงูููู)
student_id: 654pqrst-... (ุฎุงูุฏ)
status: present
method: code
marked_at: 2025-11-10 08:05:00+03
```

---

## ๐ Row Level Security (RLS)

### Profiles
- โ ุงููุณุชุฎุฏู ูุฑู ูููู ููุท
- โ ุงููุดุฑู ูุฑู ูู ุงููููุงุช
- โ ุงููุนูู ูุฑู ูููุงุช ุงูุทูุงุจ

### Courses, Sections, Schedules, Sessions
- โ ุงูุฌููุน ูููููู **ุนุฑุถ** ุงูุจูุงูุงุช
- โ ููุท ุงููุนูู ูุงููุดุฑู ูููููู **ุงูุชุนุฏูู**

### Attendance
- โ ุงูุทุงูุจ ูุฑู ุญุถูุฑู ููุท
- โ ุงููุนูู ูุฑู ุญุถูุฑ ุทูุงุจู
- โ ุงููุดุฑู ูุฑู ูู ุงูุณุฌูุงุช

### WebAuthn Credentials
- โ ูู ูุณุชุฎุฏู ูุฏูุฑ ุจูุงูุงุช ุงุนุชูุงุฏู ููุท

---

## ๐ ุงุณุชุนูุงูุงุช ุดุงุฆุนุฉ | Common Queries

### ุนุฑุถ ููุงุฏ ุงููุนูู ูุน ุงู๏ฟฝ๏ฟฝุนุจ:
```sql
SELECT 
  c.*,
  s.id as section_id,
  s.name as section_name
FROM courses c
LEFT JOIN sections s ON c.id = s.course_id
WHERE c.instructor_id = 'ูุนุฑู_ุงููุนูู';
```

### ุนุฑุถ ุฌุฏูู ุงูุทุงูุจ ุงูููู:
```sql
SELECT 
  sch.*,
  sec.name as section_name,
  c.code,
  c.name as course_name
FROM schedules sch
JOIN sections sec ON sch.section_id = sec.id
JOIN courses c ON sec.course_id = c.id
WHERE sch.day_of_week = EXTRACT(DOW FROM NOW());
```

### ุนุฑุถ ูุณุจุฉ ุญุถูุฑ ุงูุทุงูุจ:
```sql
SELECT 
  COUNT(*) FILTER (WHERE status = 'present') as present_count,
  COUNT(*) as total_count,
  (COUNT(*) FILTER (WHERE status = 'present')::FLOAT / COUNT(*) * 100) as percentage
FROM attendance
WHERE student_id = 'ูุนุฑู_ุงูุทุงูุจ';
```

---

## โ ุงูุฎูุงุตุฉ | Summary

- **8 ุฌุฏุงูู ุฑุฆูุณูุฉ** ูุชูุงููุฉ
- **Row Level Security** ุนูู ูู ุงูุฌุฏุงูู
- **ุนูุงูุงุช ูุงุถุญุฉ** ุจูู ุงูุฌุฏุงูู
- **ููุงุฑุณ** ูุชุญุณูู ุงูุฃุฏุงุก
- **Triggers** ููุชุนุงูู ุงูุชููุงุฆู ูุน ุงูุจูุงูุงุช

---

**๐ ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!**
